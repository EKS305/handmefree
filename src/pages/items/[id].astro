---
const { id } = Astro.params;

const API_URL =
  "https://handmefree-post-item.ehsankarimi27.workers.dev/item?id=" + id;

let item = null;
let error = null;

try {
  const res = await fetch(API_URL);
  const data = await res.json();

  if (!data.ok) throw new Error("Not found");
  item = data.item;
} catch {
  error = "Item not found";
}
---

{error && <p style="color:red">{error}</p>}

{item && (
  <>
    <h1>{item.title}</h1>
    <p>{item.description}</p>
    <small>
      Posted: {new Date(item.createdAt).toLocaleString()}
    </small>

    <hr />

    <h3>Add an image</h3>

    <form id="image-upload-form">
      <input
        type="file"
        id="image"
        accept="image/*"
        required
      />
      <br /><br />
      <button type="submit">Upload image</button>
      <p id="upload-status"></p>
    </form>
  </>
)}

<script is:inline>
  const form = document.getElementById("image-upload-form");
  if (form) {
    const status = document.getElementById("upload-status");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.textContent = "";
      status.style.color = "";

      const fileInput = document.getElementById("image");
      if (!fileInput.files.length) return;

      const formData = new FormData();
      formData.append("image", fileInput.files[0]);
      formData.append("itemId", "{id}");

      try {
        const res = await fetch(
          "https://handmefree-post-item.ehsankarimi27.workers.dev/upload-image",
          {
            method: "POST",
            body: formData,
          }
        );

        const data = await res.json();

        if (!data.ok) {
          status.style.color = "red";
          status.textContent = data.error || "Upload failed";
          return;
        }

        status.style.color = "green";
        status.textContent = "Image uploaded successfully";
        fileInput.value = "";
      } catch {
        status.style.color = "red";
        status.textContent = "Network error. Try again.";
      }
    });
  }
</script>
