<h3>Add an image</h3>

<form id="uploadForm" enctype="multipart/form-data">
  <input type="file" id="file" required />
  <button type="submit">Upload</button>
</form>

<p id="msg"></p>

<script>
  const form = document.getElementById("uploadForm");
  const fileInput = document.getElementById("file");
  const msg = document.getElementById("msg");
  const itemId = "{Astro.params.id}";

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.textContent = "";

    if (!fileInput.files.length) {
      msg.textContent = "No file selected";
      return;
    }

    const fd = new FormData();
    fd.append("image", fileInput.files[0]);
    fd.append("itemId", itemId);

    let res;
    try {
      res = await fetch(
        "https://handmefree-post-item.ehsankarimi27.workers.dev/upload-image",
        {
          method: "POST",
          body: fd,
        }
      );
    } catch (e) {
      msg.textContent = "Network error";
      return;
    }

    let data;
    try {
      data = await res.json();
    } catch {
      msg.textContent = "Bad server response";
      return;
    }

    if (!res.ok) {
      msg.textContent = data.error || "Upload failed";
      return;
    }

    location.reload();
  });
</script>
