---
const { id } = Astro.params;

// ✅ Items come from Pages API
const ITEMS_API = "/api/items";

// ✅ Images go to Worker
const UPLOAD_API = "https://handmefree-post-item.ehsankarimi27.workers.dev";

// R2 public dev URL
const R2_BASE = "https://pub-3750308ca5f9464a97ba881a8b7f9734.r2.dev";

let item = null;
let error = null;

try {
  const res = await fetch(`${ITEMS_API}?id=${id}`);
  const data = await res.json();
  if (!data.ok) throw new Error();
  item = data.item;
} catch {
  error = "Item not found";
}
---

{error && <p style="color:red">{error}</p>}

{item && (
  <>
    <h1>{item.title}</h1>
    <p>{item.description}</p>
    <small>Posted: {new Date(item.createdAt).toLocaleString()}</small>

    <hr />

    <h3>Images</h3>

    {item.images && item.images.length > 0 ? (
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        {item.images.map((key) => (
          <img
            src={`${R2_BASE}/${key}`}
            width="200"
            loading="lazy"
            style="border:1px solid #ccc"
          />
        ))}
      </div>
    ) : (
      <p>No images yet</p>
    )}

    <hr />

    <h3>Add an image</h3>

    <form id="uploadForm" data-item-id={id}>
      <input type="file" name="image" required />
      <button type="submit">Upload image</button>
    </form>

    <script>
      const form = document.getElementById("uploadForm");
      const itemId = form.dataset.itemId;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fd = new FormData(form);
        fd.append("itemId", itemId);

        const res = await fetch(
          "https://handmefree-post-item.ehsankarimi27.workers.dev/upload-image",
          {
            method: "POST",
            body: fd,
          }
        );

        const data = await res.json();

        if (!data.ok) {
          alert(data.error || "Upload failed");
        } else {
          location.reload();
        }
      });
    </script>
  </>
)}
